/*! (c) by Olli Kekäläinen, Rajahyöty Oy*/
(()=>{const e="function"==typeof require&&"object"==typeof process&&"function"==typeof process.exit,t="accept",s="confirm",n="leave",i="initiate",r="nudge",o="presence",a="alter",h="request",c="response",p={CLIENT2HUB:"client2hub",HUB2CLIENT:"hub2client",TERMINATE:"terminate",CLIENTDEBOUT:"clientdebout",CONNECTED:"connected"},d={};let u;Object.keys(p).forEach((e=>{d[p[e]]=!0}));class l extends(e?require("events"):EventTarget){#e;#t=0;#s;#n=!1;#i=!1;#r=[];#o;#a=0;#h=0;#c=0;#p;#d={};#u;#l="closed";#g=[];#m;constructor(t){super(),this.#p=t||{},"boolean"==typeof this.#p.debug&&(this.#n=this.#p.debug),this.#E(),e?process.on("beforeExit",(()=>{this.#v()})):window.addEventListener("unload",(e=>{this.#v()}))}get connectCount(){return this.#t}get deboutCluster(){return this.#p.deboutCluster}get deboutReceiver(){return this.options.deboutReceiver||!1}set deboutReceiver(e){return e=!!e,this.options.deboutReceiver!==e&&(this.options.deboutReceiver=e,this.#f(e)),this.options.deboutReceiver}get filterTags(){return this.#r}get id(){return this.#o}get linkageKey(){return this.#p.linkageKey}get options(){return this.#p.options}get params(){return this.#p}get properties(){return this.#p.properties}get readyState(){return(this.#m||{}).readyState}get reopenInterval(){return this.#p.reopenInterval||3e3}get resendInterval(){return this.#p.resendInterval||100}get startTime(){return this.#u?new Date(this.#u):null}get tags(){return S(this.#p.tags)}get timeout(){return this.#p.timeout||3e4}get url(){return this.#p.url}get userid(){return this.#p.userid}get version(){return"1.0.0 (20230303)"}addTag(e){let t=0;return(e=S(e)).forEach((e=>{this.tags.indexOf(e)<0&&++t&&this.tags.push(e)})),t&&this.#b({type:"addTag",content:e}).send(),this}addFilterTag(e){let t=0;return S(e).forEach((e=>{this.#r.indexOf(e)<0&&(this.#r.push(e),t++)})),t&&this.#w((()=>{})),this}close(){return this.#l="closing",this.#v(),this.#y(!1),this.#m.close(1e3),this.#m=void 0,this.#u=void 0,this}deboutSelection(e){return this.#b({type:"deboutSelection",content:e}).send(),this}dispatchEvent(t){e?this.emit(t.type,t):super.dispatchEvent(t)}dispatchErrorEvent(e,t){const s=new m("error");"object"==typeof e?s.error=e:t?(s.error=new Error(t),s.error.code=e):s.error=new Error(e),this.dispatchEvent(s)}filter(e){const t=[];for(let s in this.#d)e(this.#d[s])&&t.push(this.#d[s]);return t}find(e){for(let t in this.#d)if(e(this.#d[t]))return this.#d[t]}forEachPeer(e){for(let t in this.#d)e(this.#d[t]);return this}newId(){return y()}newPeerEvent(e,t){return new E(e,t)}notify(e){return e.peer&&void 0!==e.content&&this.#b({type:"notify",peer:e.peer,name:e.name,content:e.content}).send(),this}off(t,s){return e?this.removeListener(t,s):this.removeEventListener(t,s),this}on(t,s){return e?super.on(t,s):this.addEventListener(t,s),this}once(t,s){return e?super.once(t,s):this.addEventListener(t,s,{once:!0}),this}open(){return this.linkageKey?(this.#y(),this.#S()):this.dispatchErrorEvent("E_LINKAGEKEYNOTSPECIFIED"),this}publish(e){return e.channel&&e.message?this.#b({type:"publish",content:{channel:e.channel,message:e.message,options:"object"==typeof e.options?e.options:{}}}).send():this.dispatchErrorEvent("E_PUBLISH_SYNTAXERROR"),this}removeFilterTag(e){let t=0;return S(e).forEach((e=>{const s=this.#r.indexOf(e);s>=0&&(this.#r.splice(s,1),t++)})),t&&this.#w((()=>{})),this}removeTag(e){let t=0;return(e=S(e)).forEach((e=>{const s=this.tags.indexOf(e);s>=0&&++t&&this.tags.splice(s,1)})),t&&this.#b({type:"removeTag",content:e}).send(),this}request(e){return e.peer&&void 0!==e.content&&e.onResponse?this.#b({type:h,peer:e.peer,name:e.name,content:e.content},e.onResponse,e.timeout).send():this.dispatchErrorEvent("E_REQUEST_SYNTAXERROR"),this}respond(e){e.peer&&void 0!==e.content&&e.messageid&&this.#b({type:c,peer:e.peer,messageid:e.messageid,name:e.name,content:e.content}).send()}setProperties(e={}){return Object.assign(this.properties,e),this.#b({type:"setProperties",content:e}).send(),this}subscribe(e){if("string"==typeof e.channels&&(e.channels=e.channels.split(",")),Array.isArray(e.channels)&&e.channels.length){const t=[];e.channels.forEach((e=>{e=e.trim(),this.#g.indexOf(e)<0&&(t.push(e),this.#g.push(e))})),t.length&&this.#b({type:"subscribe",content:{channels:t}}).send()}else if(!Array.isArray(e.channels)){let t="Invalid OkPeerConnection.subscribe() parameters: "+JSON.stringify(e);this.dispatchErrorEvent("E_SUBSCRIBE_SYNTAXERROR",t)}return this}unsubscribe(e){if("string"==typeof e.channels&&(e.channels=e.channels.split(",")),Array.isArray(e.channels)&&e.channels.length){const t=[];e.channels.forEach((e=>{e=e.trim();const s=this.#g.indexOf(e);s>=0&&(t.push(e),this.#g.splice(s,1))})),t.length&&this.#b({type:"unsubscribe",content:{channels:e.channels}}).send()}else this.dispatchErrorEvent("E_UNSUBSCRIBE_SYNTAXERROR");return this}_debout(e){return this.#b({type:"debout",content:e}).send(),this}_getPeer(e){return this.#d[e]}_send(e){const t=()=>{try{this.#m.send(JSON.stringify(e.message))}catch(e){this.dispatchErrorEvent(e)}};if(this.#m){if(1==this.readyState)t();else if(0==this.readyState){const e=Date.now(),s=setInterval((()=>{1==this.readyState?(clearInterval(s),t()):Date.now()-e>this.timeout&&(clearInterval(s),this.dispatchErrorEvent("E_CONNECTIONTIMEOUT"))}),this.resendInterval)}}else this.dispatchErrorEvent("E_UNCONNECTED")}get#T(){return e?0:Math.ceil(this.#a/2.5)}get#O(){return e?0:3*this.#a+2e3}get#C(){return"r0gby7a-lae262ja-"+this.id}#N(e){return this.#R(e,this.#r)}#S(t=!1){if(t||"closed"==this.#l)if(this.#l="opening",e)try{const e=require("ws");this.#m=new e(this.#k()),this.#m.on("open",(()=>{this.#l="opened",this.#u=Date.now(),++this.#t,this.dispatchEvent(new m("open"))})),this.#m.on("error",(e=>{this.#l="closed";const t=e.error||e;t.message.indexOf("(404)")>0||"ENOTFOUND"==t.code?(this.__invalidSocket=!0,this.dispatchErrorEvent(new Error("E_NOTFOUND (Invalid WebSocket url '"+this.url+"')"))):"ECONNREFUSED"==t.code?this.#I():this.dispatchErrorEvent(new Error("E_PEERCONNECTION (Code: "+(t.code||0)+")"))})),this.#m.on("message",((e,t)=>{this.#_(e)})),this.#m.on("close",((e,t)=>{this.__invalidSocket||("closing"!==this.#l&&1e3!==e?this.#I():this.dispatchEvent(new m("close"))),this.#l="closed"}))}catch(e){console.log("**** PeerHub Connection WebSocket failure ****"),console.log(e),setTimeout((()=>{this.dispatchErrorEvent(e)}),1e3)}else this.#m=new WebSocket(this.#k()),this.#m.onopen=()=>{this.#l="opened",this.#u=Date.now(),++this.#t,this.dispatchEvent(new m("open"))},this.#m.onerror=e=>{this.#l="closed","ECONNREFUSED"==e.code?this.#I():this.dispatchErrorEvent(new Error("E_PEERCONNECTION (Code: "+(e.code||0)+")"))},this.#m.onmessage=e=>{this.#_(e.data)},this.#m.onclose=e=>{"closing"!==this.#l&&1e3!==e.code?this.#I():this.dispatchEvent(new m("close")),this.#l="closed"}}#_(e){try{if("message"==(e=JSON.parse(e)).type&&this.#s&&"object"==typeof e.content&&e.content.channel==this.#s)return event=new m("debout"),event.data={time:e.content.time,message:e.content.message},void this.dispatchEvent(event);this.#A(e)}catch(e){this.dispatchErrorEvent(e)}}#R(e,t=[]){let s=0;for(;s<t.length;)if(e.tags.indexOf(t[s++])<0)return!1;return!0}#M(e){const t={id:e,deboutCluster:this.deboutCluster,userid:this.userid,options:this.options,properties:this.properties,linkageKey:this.linkageKey,startTime:this.#u,tags:this.tags};this.#n&&console.log("---- "+i+" ----"),this.#n&&console.log(t),this.#b({type:i,content:t}).send()}#v(e){this.#n&&console.log("---- leave "+this.id+" ----"),this.#m.send(JSON.stringify({type:n}))}#A(e){return new f(this,e)}#b(e,t,s){return new b(this,e,t,s)}#P(e){const t=e.message.content;this.#o?this.#M(this.#o):(this.#o=t.id,this.#M()),this.#s=t.deboutChannel,this.options.deboutReceiver&&this.#f(!0)}#D(e){this.#U(e.message.content)}#x(e){this.#p.userid=e.message.content.userid,this.#w((()=>{}))}#j(e){this.#q(e.message.content)}#H(t){if(!e){const e=t.message.content;this.#a=e.interval,this.#e||(this.#e=this.#K()),this.#c=Date.now()}}#L(e){this.#F(e.message.content)}#F(e,t=!0){this.#N(e)&&(this.#d[e.id]=new w(this,e),this.#n&&console.log("---- addpeer ----"),this.#n&&console.log(this.#d[e.id]),t&&this.dispatchEvent(this.newPeerEvent("addpeer",this.#d[e.id])))}#U(e){this.#n&&console.log("---- alterpeer ----"),this.#n&&console.log(e),this.#d[e.id]&&this.#d[e.id]._modify(e),this.dispatchEvent(this.newPeerEvent("alterpeer",this.#d[e.id]))}#q(e){this.#n&&console.log("---- removepeer ----"),this.#n&&console.log(e),this.#d[e.id]&&delete this.#d[e.id];const t=new w(this,e);this.dispatchEvent(this.newPeerEvent("removepeer",t))}#k(){let t=this.url.replace("https:","wss:").replace("http:","ws:");return e||"https:"!=location.protocol||(t=t.replace("ws:","wss:")),t}#I(){return setTimeout((()=>{this.#S()}),this.reopenInterval),this}#w(e=(()=>{})){this.#b({type:"retrievePeers",content:{linkageKey:this.linkageKey}},(t=>{const s=Object.assign({},this.#d);this.#d={},t.content.peers.forEach((e=>{const t=!!s[e.id];if(this.#F(e,!t),t&&(n=e,i=s[e.id],JSON.stringify([n.tags,n.properties])!=JSON.stringify([i.tags,i.properties]))){const t=new w(this,e);this.dispatchEvent(this.newPeerEvent("alterpeer",t)),delete s[e.id]}var n,i})),Object.entries(s).forEach((([e,t])=>{this.dispatchEvent(this.newPeerEvent("removepeer",t))})),e()}),this.timeout).send()}#f(e){e?this.subscribe({channels:[this.#s]}):this.unsubscribe({channels:[this.#s]})}#y(e=!0){const i=e=>{this.#P(e)},h=e=>{this.#x(e)},c=e=>{this.#j(e)},p=e=>{this.#H(e)},d=e=>{this.#D(e)},u=e=>{this.#L(e)};e&&!this.#i&&(this.on(t,i),this.on(a,d),this.on(s,h),this.on(n,c),this.on(r,p),this.on(o,u),this.#i=!0),!e&&this.#i&&(this.off(t,i),this.off(a,d),this.off(s,h),this.off(n,c),this.off(r,p),this.off(o,u),this.#i=!1)}#K(){if(!e)return setInterval((()=>{this.#c&&1!==this.readyState&&0!==this.readyState&&Date.now()-this.#c>this.#O&&(console.log("OkPeerConnection reconnecting after awakening"),e||this.dispatchEvent(new m("awakening")),this.#S(!0))}),this.#T)}#E(){this.#p.options=this.#p.options||{},this.options.deboutReceiver=this.options.deboutReceiver??!1,this.options.peerInitiationReceiver=this.options.peerInitiationReceiver??!0,this.options.peerInitiationSender=this.options.peerInitiationSender??!0,this.#p.tags=this.#p.tags||[],this.#p.userid=this.#p.userid||"",this.#p.properties=this.#p.properties||{},this.#o=this.#p.id}}class g{#B;constructor(e){this.#B=e}get type(){return this.#B}}class m extends(e?g:Event){constructor(e){super(e)}}class E extends m{#J;constructor(e,t){if("string"==typeof e)super(e);else{if("object"!=typeof e)throw new Error("E_SYNTAX: Invalid first parameter when initializing PeerEvent.");super(e.type),t=t||e.peer}this.#J=t}get peer(){return this.#J}set peer(e){return this.#J=e,this.#J}}class v{#Y;#X={};constructor(e,t){this.#Y=e,t&&(this.#X=t)}get content(){return this.#X.content}get data(){return this.#X}get id(){return this.#X.messageid}get message(){return this.#X}get name(){return this.#X.name}get peer(){return"string"==typeof this.#X.peer?this.peerConnection._getPeer(this.#X.peer):this.#X.peer}get peerConnection(){return this.#Y}get time(){return new Date(this.timeAsMilliseconds)}get timeAsMilliseconds(){return parseInt(this.id.substr(8),36)}get type(){return this.#X.type}}class f extends v{constructor(e,t){let s;if(super(e,t),this.type==c&&(s=u.get(this),s&&s.conveyResponse(this)),!s){const e=new m(this.type);e.message=this,this.peerConnection.dispatchEvent(e)}}respond(e){this.type==h&&(this.peer?this.peerConnection.respond({name:this.name,messageid:this.id,peer:this.peer.id,content:e}):this.peerConnection.dispatchErrorEvent("E_NOPEER_ON_REQUEST"))}}class b extends v{constructor(e,t,s,n){super(e,t),this.message.messageid=this.message.messageid||y(),s&&u.add(this,s,n)}conveyResponse(e){this.onResponse?this.onResponse(e):this.peerConnection.dispatchErrorEvent("E_MISSING_ONRESPONSE")}send(){this.peerConnection._send({message:this.message})}}class w{#p;#W;constructor(e,t){this.#W=e,this.#p=t}get connection(){return this.#W}get id(){return this.#p.id}get linkageKey(){return this.#p.linkageKey}get properties(){return this.#p.properties}get startTime(){return new Date(this.#p.startTime)}get tags(){return S(this.#p.tags)}get userid(){return this.#p.userid}hasAllTags(e=[]){const t=e.length;let s=0;for(;s<t;)if(this.tags.indexOf(e[s++])<0)return!1;return!0}hasAnyTag(e=[]){const t=e.length;let s=0;for(;s<t;)if(this.tags.indexOf(e[s++])>=0)return!0;return!1}hasTag(e){return this.tags.indexOf(e)>=0}notify(e){return this.#W.notify(Object.assign(e,{peer:this.id})),this}request(e){return this.#W.request(Object.assign(e,{peer:this.id})),this}_modify(e={}){return Object.assign(this.#p,e),this}}function y(){const e=(new Date).getTime().toString(36),t=15-e.length,s="abcdefghijklmnopqrstuvwxyz0123456789";let n=s[Math.floor(26*Math.random())]+Math.random().toString(36).split(".")[1];for(;n.length<t;)n+=s[Math.floor(36*Math.random())];return n.substr(0,t)+"-"+e}function S(e){return Array.isArray(e)?e:null==e?[]:[e]}u=new class{#Q={};constructor(){}add(e,t,s){this.#Q[e.id]=e,e._onResponse=t,e.onResponse=t=>{e._onResponse(t),this.#z(e)},e.timer=setTimeout((()=>{this.#z(e),e.peerConnection.dispatchErrorEvent("E_REQUESTTIMEOUT: Request name '"+(e.name||"UNKNOWN")+"',  id: "+e.messageid+",  peer: "+e.peer)}),s||2e4)}get(e){return this.#Q[e.id]}#z(e){e.timer&&(clearTimeout(e.timer),e.timer=void 0,this.#Q[e.id]&&delete this.#Q[e.id])}},e?module.exports=l:window.OkPeerConnection=l})();